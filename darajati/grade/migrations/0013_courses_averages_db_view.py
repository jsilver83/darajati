# Generated by Django 2.0.1 on 2018-12-04 11:26

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('grade', '0012_sections_averages_db_view'),
    ]

    operations = [
        migrations.RunSQL(
            """
            DROP VIEW IF EXISTS grade_coursesaveragesview;
            
            CREATE OR REPLACE VIEW grade_coursesaveragesview AS 
            SELECT ROW_NUMBER() OVER () AS ID, Q.*, Q.GRADES_AVERAGE / Q.WEIGHT * 100 GRADES_AVERAGE_PERCENTAGE FROM (
            SELECT
              GRADE_GRADEFRAGMENT.COURSE_OFFERING_ID,
              ENROLLMENT_SEMESTER.ID SEMESTER_ID, 
              ENROLLMENT_SEMESTER.CODE SEMESTER_CODE, 
              ENROLLMENT_COURSE.ID COURSE_ID, 
              ENROLLMENT_COURSE.CODE COURSE_CODE, 
              GRADE_GRADEFRAGMENT.ID GRADE_FRAGMENT_ID,
              GRADE_GRADEFRAGMENT.BOUNDARY_TYPE, 
              GRADE_GRADEFRAGMENT.CATEGORY, 
              GRADE_GRADEFRAGMENT.DESCRIPTION, 
              GRADE_GRADEFRAGMENT.WEIGHT, 
              AVG(GRADE_STUDENTGRADE.GRADE_QUANTITY) GRADES_AVERAGE
            FROM 
              PUBLIC.GRADE_GRADEFRAGMENT, 
              PUBLIC.GRADE_STUDENTGRADE, 
              PUBLIC.ENROLLMENT_COURSEOFFERING, 
              PUBLIC.ENROLLMENT_COURSE, 
              PUBLIC.ENROLLMENT_SEMESTER,
              PUBLIC.ENROLLMENT_ENROLLMENT
            WHERE 
              GRADE_GRADEFRAGMENT.COURSE_OFFERING_ID = ENROLLMENT_COURSEOFFERING.ID AND
              GRADE_STUDENTGRADE.GRADE_FRAGMENT_ID = GRADE_GRADEFRAGMENT.ID AND
              ENROLLMENT_COURSEOFFERING.SEMESTER_ID = ENROLLMENT_SEMESTER.ID AND
              ENROLLMENT_COURSEOFFERING.COURSE_ID = ENROLLMENT_COURSE.ID AND
              ENROLLMENT_ENROLLMENT.ID = GRADE_STUDENTGRADE.ENROLLMENT_ID AND
              GRADE_STUDENTGRADE.GRADE_QUANTITY IS NOT NULL AND
              ENROLLMENT_ENROLLMENT.ACTIVE = TRUE
            GROUP BY
              GRADE_GRADEFRAGMENT.COURSE_OFFERING_ID,
              ENROLLMENT_SEMESTER.ID, 
              ENROLLMENT_SEMESTER.CODE, 
              ENROLLMENT_COURSE.ID, 
              ENROLLMENT_COURSE.CODE, 
              GRADE_GRADEFRAGMENT.ID,
              GRADE_GRADEFRAGMENT.BOUNDARY_TYPE,
              GRADE_GRADEFRAGMENT.CATEGORY, 
              GRADE_GRADEFRAGMENT.DESCRIPTION, 
              GRADE_GRADEFRAGMENT.WEIGHT
              ) Q;
            """
        ),
    ]